<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Top 5 Contributors</title>
	<style type="text/css" media="screen">
        #powered_img{
            margin-top:10px;
            float:left;
        }
        #combobox{
            margin-top:10px;
            float:right;
        }
		body, html {background-color: #F0ECE1;font-family: arial, sans-serif; font-size: 12px; text-align: center; padding:0; margin:0;}
		#selections { margin-top: 5px;}
        .headerRow {
            background-color:#DCD8CE;
        }
        .tableRow {
            background-color:#f7f5f0;
            border-color:#E3DBC8;
        }
        .tableCell{
            border-width:1px;
            border-style:solid;
            border-color:#E3DBC8;
        }
	</style>
	<meta name="author" content="Petr Pridal - Klokan Technologies GmbH">
	<!--  Date: 2011-10-24 -->
	<script type="text/javascript" src="http://www.google.com/jsapi"></script>
	<script type="text/javascript" id="script">
	google.load('visualization', '1', {'packages':['table']});

	function main() {
	  var tableid = '1gpUBes9cpOkH3h-fNyS_4dnuLelIY-bSuWdNfqw';

	  var queryText = encodeURIComponent("SELECT 'collection', 'status', COUNT() FROM "+ tableid + " GROUP BY 'collection', 'status'");

	  var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
	  query.send(drawTable);
	}

	function getInstitutionName(institution) {
		var mapping = {
			'Jihočeská vědecká knihovna v Českých Budějovicích': ['cbvk'],
			'Univerzita Karlova v Praze': ['cuni'],
			'Historický ústav AVČR': ['huav'],
			'Městská knihovna v Praze': ['mlp'],
			'Masarykova univerzita': ['muni'],
			'Muzeum Brněnska': ['muzeumbrnenska'],
			'Městské muzeum Jaroměř': ['muzeumjaromer'],
			'Moravská zemská knihovna': ['mzk'],
			'Národní knihovna ČR': ['nkp'],
			'Výzkumný ústav geodetický, topografický a kartografický': ['nkpvugtk'],
			'Národní technická knihovna': ['ntk', 'ntk2'],
			'Národní technické muzeum': ['ntm'],
			'Rajhrad': ['rajhrad2'],
			'Státní oblastní archiv v Plzni': ['soaplzen'],
			'Státní oblastní archiv v Třeboni': ['soatrebon'],
			'Státní oblastní archiv v Zámrsku': ['soazamrsk'],
			'Univerzita Jana Evangelisty Purkyně': ['ujep'],
			'Vědecká knihovna v Olomouci': ['vkol'],
			'Západočeské muzeum v Plzni': ['zcm']
		};

		for (let key in mapping) {
			let m = mapping[key];
			if (m.indexOf(institution) > -1) {
				return key;
			}
		}
		return institution;
	}

	function mergeSame(data) {
		var same = [['ntk', 'ntk2']]

		same.forEach(function(s) {
			var first = s[0];
			for (let i = 1; i < s.length; i++) {
				data[s[0]]['georeferenced'] += data[s[i]]['georeferenced'];
				data[s[0]]['nongeoreferenced'] += data[s[i]]['nongeoreferenced'];
				data[s[0]]['not_a_map'] += data[s[i]]['not_a_map'];
				delete data[s[i]];
			}
		});
	}

	function drawTable(response) {

	  var table = new google.visualization.Table(document.getElementById('visualization'));
      var respData = response.getDataTable();
			var size = respData.getNumberOfRows();
			var data = {}

			for (let i = 0; i < size; i++) {
				let institution = respData.getValue(i, 0);
				let status = respData.getValue(i, 1);
				let count = respData.getValue(i, 2);

				if (!status) {
					status = 'nongeoreferenced'
				}

				if (!data[institution]) {
					data[institution] = {};
				}
				data[institution][status] = count;
			}

			mergeSame(data);

			var dataTable = new google.visualization.DataTable();
			dataTable.addColumn('string', 'Instituce');
			dataTable.addColumn('number', 'Zpracované');
			dataTable.addColumn('number', 'Nezpracované');
			dataTable.addColumn('number', 'Nelze umístit');
			dataTable.addColumn('number', 'Celkem');

			var sumGeoreferenced = 0;
			var sumNonGeoreferenced = 0;
			var sumNotamap = 0;
			var sumSum = 0;

			for (let institution in data) {
				var georeferenced = data[institution]['georeferenced'] || 0;
				var nongeoreferenced = data[institution]['nongeoreferenced'] || 0;
				var notamap = data[institution]['not_a_map'] || 0;
				var sum = georeferenced + nongeoreferenced + notamap;

				sumGeoreferenced += georeferenced;
				sumNonGeoreferenced += nongeoreferenced;
				sumNotamap += notamap;
				sumSum += sum;

				dataTable.addRow([getInstitutionName(institution), georeferenced, nongeoreferenced, notamap, sum]);
			}
			dataTable.addRow(['Celkem', sumGeoreferenced, sumNonGeoreferenced, sumNotamap, sumSum]);

      var cssClassNames = {headerRow: 'headerRow',
				tableRow: "tableRow",
        headerCell: "tableCell",
        tableCell: "tableCell"
        };
	  	table.draw(dataTable, {alternatingRowStyle: false, cssClassNames: cssClassNames, width: '600px'});
	}

	</script>
	</head>
	<body onload="main();">
	<div id="visualization"></div>
    <div id="powered_img">
        <img src="/img/powered.png"/>
    </div>
</body>
</html>
